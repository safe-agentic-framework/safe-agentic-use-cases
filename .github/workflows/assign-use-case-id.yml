name: Validate Claim

on:
  issues:
    types:
      - opened
      - edited
      - reopened

permissions:
  contents: read
  issues: write

concurrency:
  group: claim-validation-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  validate-claim:
    if: contains(github.event.issue.labels.*.name, 'claim')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate claim and check conflicts
        uses: actions/github-script@v7
        env:
          REGISTRY_FILE: use-cases.naics2022.crosswalk.json
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require("fs");

            const BOT_MARKER = "<!-- safe-claim-bot -->";
            const ID_REGEX = /SAFE-UC-\d{4}/;

            const issue = context.payload.issue;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issueNumber = issue.number;
            const author = issue.user.login;

            // ── Helpers ─────────────────────────────────────────────

            const normalize = (value) => (value || "").replace(/\r/g, "").trim();

            const parseFormSections = (body) => {
              const sections = {};
              let heading = null;
              let sectionLines = [];

              for (const line of normalize(body).split("\n")) {
                if (line.startsWith("### ")) {
                  if (heading) {
                    sections[heading] = normalize(sectionLines.join("\n"));
                  }
                  heading = line.slice(4).trim();
                  sectionLines = [];
                  continue;
                }
                if (heading) {
                  sectionLines.push(line);
                }
              }

              if (heading) {
                sections[heading] = normalize(sectionLines.join("\n"));
              }

              return sections;
            };

            const listBotComment = async () => {
              const comments = await github.paginate(github.rest.issues.listComments, {
                owner,
                repo,
                issue_number: issueNumber,
                per_page: 100,
              });

              return comments.find(
                (comment) =>
                  comment.user?.login === "github-actions[bot]" &&
                  comment.body?.includes(BOT_MARKER)
              );
            };

            const upsertBotComment = async (message) => {
              const body = `${BOT_MARKER}\n${message}`;
              const existing = await listBotComment();

              if (existing) {
                await github.rest.issues.updateComment({
                  owner,
                  repo,
                  comment_id: existing.id,
                  body,
                });
                return;
              }

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: issueNumber,
                body,
              });
            };

            // ── Parse dropdown value ────────────────────────────────
            // Dropdown format: "SAFE-UC-XXXX — Title"

            const sections = parseFormSections(issue.body || "");
            const idField = normalize(sections["SAFE Use Case ID"]);

            if (!idField) {
              core.info("Issue body is missing SAFE Use Case ID field; skipping.");
              return;
            }

            const idMatch = idField.match(ID_REGEX);
            if (!idMatch) {
              await upsertBotComment(
                "Could not find a valid `SAFE-UC-XXXX` ID in the selected value."
              );
              return;
            }

            const claimedId = idMatch[0].toUpperCase();

            // ── Validate ID exists in registry ──────────────────────

            const registry = JSON.parse(
              fs.readFileSync(process.env.REGISTRY_FILE, "utf8")
            );
            const entry = registry.find(
              (e) => e.id.toUpperCase() === claimedId
            );

            if (!entry) {
              await upsertBotComment(
                [
                  `\`${claimedId}\` is not in the current registry.`,
                  "",
                  "If this is a new workflow, use **[Propose New Use Case](../../issues/new?template=propose-new-use-case.yml)** instead.",
                ].join("\n")
              );
              return;
            }

            if (entry.status !== "seed") {
              await upsertBotComment(
                `\`${claimedId}\` has status **${entry.status}** — only seeds can be claimed.`
              );
              return;
            }

            // ── Check for conflicting claims ────────────────────────

            const openIssues = await github.paginate(
              github.rest.issues.listForRepo,
              {
                owner,
                repo,
                state: "open",
                labels: "use-case",
                per_page: 100,
              }
            );

            const conflicts = openIssues
              .filter((i) => i.number !== issueNumber && !i.pull_request)
              .filter((i) => {
                const text = `${i.title}\n${i.body || ""}`.toUpperCase();
                return text.includes(claimedId);
              })
              .map((i) => `#${i.number}`);

            if (conflicts.length > 0) {
              await upsertBotComment(
                [
                  `Heads up: \`${claimedId}\` is already referenced by open issue(s): ${conflicts.join(", ")}.`,
                  "Coordinate in-thread to avoid duplicate work on the same ID.",
                ].join("\n")
              );
              // Continue — don't block, just warn
            }

            // ── Update issue title with the claimed ID ──────────────

            const title = entry.title;
            const newTitle = `[Claim] ${claimedId} — ${title}`;

            if (issue.title !== newTitle) {
              await github.rest.issues.update({
                owner,
                repo,
                issue_number: issueNumber,
                title: newTitle,
              });
            }

            // ── Assign issue to the claimant ────────────────────────

            await github.rest.issues.addAssignees({
              owner,
              repo,
              issue_number: issueNumber,
              assignees: [author],
            });

            // ── Post or clear bot comment ───────────────────────────

            if (conflicts.length === 0) {
              const existing = await listBotComment();
              if (existing) {
                await github.rest.issues.deleteComment({
                  owner,
                  repo,
                  comment_id: existing.id,
                });
              }

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: issueNumber,
                body: [
                  BOT_MARKER,
                  `Claimed **${claimedId}** — *${title}*.`,
                  "",
                  "Next steps:",
                  `1. Create \`use-cases/${claimedId}/README.md\` using the [template](../../blob/main/templates/use-case-template.md)`,
                  `2. Update \`use-cases.naics2022.crosswalk.json\``,
                  `3. Open a PR referencing this issue (closes #${issueNumber})`,
                ].join("\n"),
              });
            }
